<html>
    <head>
        <title>Crypton experiments</title>
        <script src="js/openpgp.js"></script>
    </head>
    <body>
        <div style="border:solid black;">
            <h3>Encrypt</h3>
            public key: <textarea id="public_key"></textarea><br/>
            <input type="button" id="do_encrypt" onClick="doEncrypt()" value="encrypt"/></br>
            output: <textarea id="encrypt_output"></textarea>
        </div>

        <div style="border: solid red;">
            <h3>Decrypt</h3>
            private key: <textarea id="private_key"></textarea></br>
            secret: <input type="text" id="decrypt_secret"></br>
            <input type="button" id="do_decrypt" onClick="doDecrypt()" value="decrypt"/></br>
            output: <textarea id="decrypt_output"></textarea>
        </div>

        <div style="border: solid green;">
            <h3>Generate Keys</h3>
            name <input type="text" id="key_userid"></br>
            email <input type="text" id="key_email"></br>
            secret: <input type="text" id="key_secret"></br>
            <input type="button" id="do_keys" onClick="doKeys()" value="generate keys"/></br>
            private key: <textarea id="new_private_key"></textarea></br>
            public key: <textarea id="new_public_key"></textarea></br>
        </div>

        <script type='text/javascript'>
            console.log('script tag loaded');

            openpgp.initWorker({ path:'js/openpgp.worker.js' });
            openpgp.config.aead_protect = true

            function doEncrypt(){
                console.log('got doEncrypt()');

                var public_key = document.getElementById('public_key').value;

                console.log('public_key: ' + public_key);

                var options = {
                    data: 'Hello World!',
                    publicKeys: openpgp.key.readArmored(public_key).keys
                };

                openpgp.encrypt(options).then(function(ciphertext){
                    console.log(ciphertext);
                    document.getElementById('encrypt_output').value = ciphertext.data;
                });
            }

            function doDecrypt(){

                // debuging based on test here: https://github.com/openpgpjs/openpgpjs/blob/master/test/general/openpgp.js#L565
                console.log('got doDecrypt()');

                var secret = document.getElementById('decrypt_secret').value;

                console.log('secret: ' + secret);

                //var encrypted_pk = openpgp.key.readArmored(document.getElementById('private_key').value); 

                //console.log('encrypted_pk: ' + JSON.stringify(encrypted_pk));

                //encrypted_pk.keys[0].decrypt(secret).then(decrypted_

                //console.log('decrypted_pk: ' + JSON.stringify(decrypted_pk));

                //console.log('encrypted_pk after decrypt(): ' + JSON.stringify(encrypted_pk));

                // decrypt private key
                //var secret = document.getElementById('decrypt_passphrase').value;
                //console.log('secret: ' + secret);
    
                var pk = openpgp.key.readArmored(document.getElementById('private_key').value);
                console.log('pk: ' + JSON.stringify(pk));

                var keyOptions = {
                    message: openpgp.message.readArmored(document.getElementById('encrypt_output')),
                    privateKey: pk.keys[0]
                };

                var sessionKey = openpgp.decryptSessionKey(keyOptions);
                console.log('sessionKey: ' + sessionKey);

                var options = {
                    message: openpgp.message.readArmored(document.getElementById('encrypt_output')),
                    sessionKey: sessionKey 
                };

                openpgp.decrypt(options).then(function(plaintext){
                    console.log(plaintext);
                    document.getElementById('decrypt_output').value = plantext.data;
                });
            }

            function doKeys(){
                console.log('got doKeys()');

                var key_name = document.getElementById('key_userid').value;
                var key_email = document.getElementById('key_email').value;
                var key_secret = document.getElementById('key_secret').value;
                
                var options = {
                    userIds: [{name:key_name, email:key_email}],
                    numBits: 4096,
                    passphrase: key_secret
                };

                console.log('options: ' + JSON.stringify(options));

                openpgp.generateKey(options).then(function(key){
                    console.log('key: ' + JSON.stringify(key));
                    document.getElementById('new_private_key').value = key.privateKeyArmored;
                    document.getElementById('new_public_key').value = key.publicKeyArmored;
                });
            }

        </script>
    </body>
</html>
